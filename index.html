<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Revis√£o Din√¢mica do 2¬∫ Ano EF - Qualidade e BNCC</title>

<script src="https://cdn.tailwindcss.com"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-JT5Q6BV0XL"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-JT5Q6BV0XL');
</script>
<script src="questions_mat.js"></script>
<script src="questions_lin.js"></script>
<script src="questions_cie.js"></script>
<script src="questions_ch.js"></script>

<style>
/* Estilo base com fonte Inter (Para apar√™ncia infantil e moderna) */
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
body {
    font-family: 'Inter', sans-serif;
    background-color: #fce4ec; /* Rosa claro base */
    transition: background-color 0.5s ease-in-out;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}
.container-box {
    max-width: 650px;
    min-height: 400px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}
.theme-button {
    background-color: #4CAF50; /* Verde principal */
    transition: background-color 0.2s;
}
.theme-button:hover {
    background-color: #45a049;
}

/* Cores por Mat√©ria */
.color-math { background-color: #ffcc80; border-color: #ff9800; } /* Laranja Claro */
.color-portuguese { background-color: #81d4fa; border-color: #03a9f4; } /* Azul Claro */
.color-science { background-color: #a5d6a7; border-color: #4caf50; } /* Verde Claro */
.color-history { background-color: #ffab91; border-color: #ff5722; } /* Vermelho/Terra Claro */
.color-final { background-color: #ce93d8; border-color: #9c27b0; } /* Roxo Claro */

/* Classe para Desabilitar Op√ß√µes */
.disabled-option {
    opacity: 0.6;
    pointer-events: none;
    filter: grayscale(100%);
}

/* Anima√ß√£o de Entrada e Sa√≠da */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.4s ease-out;
}
</style>
</head>

<body>

<div id="app" class="container-box bg-white p-6 md:p-10 rounded-3xl shadow-2xl animate-fade-in">
    </div>

<script>
// --- Vari√°veis de Estado Global ---
const state = {
    currentStage: 1, // 1: Sele√ß√£o, 3: Atividade, 4: Feedback, 5: Relat√≥rio, 6: Fim
    currentSubject: null,
    subjectName: null,
    totalQuestions: 0,
    questions: [],
    currentQuestionIndex: 0,
    selectedOption: null,
    correctAnswers: 0,
    incorrectAnswers: 0,
    report: {
        totalQuestions: 0,
        correct: 0,
        incorrect: 0,
        details: {}, // Armazena contagem de acertos/erros por habilidade (skill)
    },
    // Estado para o feedback por habilidade
    skillFeedback: null,
    isFinalReview: false,
};

// --- FUN√á√ïES DE SETUP E UTILS ---

/**
 * Embaralha um array (algoritmo Fisher-Yates).
 * @param {Array} array
 */
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

/**
 * Seleciona um subconjunto aleat√≥rio de N quest√µes.
 * @param {Array} bank - Banco de quest√µes.
 * @param {number} N - N√∫mero de quest√µes a selecionar.
 * @returns {Array} Subconjunto de quest√µes.
 */
function selectRandomQuestions(bank, N = 10) {
    const shuffledBank = [...bank];
    shuffle(shuffledBank);
    // Garante que o n√∫mero de quest√µes n√£o exceda o tamanho do banco
    return shuffledBank.slice(0, Math.min(N, bank.length));
}

// Objeto para carregar os bancos de quest√µes
// Os nomes das propriedades devem coincidir com state.currentSubject:
// math, portuguese, science, history
const localQuestionBanks = {
    math: typeof questionBank_mat !== 'undefined' ? questionBank_mat : [],
    portuguese: typeof questionBank_lin !== 'undefined' ? questionBank_lin : [],
    science: typeof questionBank_cie !== 'undefined' ? questionBank_cie : [],
    // CORRE√á√ÉO: Trocado questionBank_ch por questionBank_hum para coincidir com o arquivo questions_ch.js
    history: typeof questionBank_hum !== 'undefined' ? questionBank_hum : [], 
};

/**
 * Fun√ß√£o de inicializa√ß√£o do quiz para o assunto selecionado.
 * @param {string} subject - Chave do assunto ('math', 'portuguese', etc.).
 * @param {string} name - Nome completo do assunto.
 * @param {boolean} isFinalReview - Se √© a revis√£o final de 40 quest√µes.
 */
function startQuiz(subject, name, isFinalReview = false) {
    let allQuestions = [];
    state.currentSubject = subject;
    state.subjectName = name;
    state.isFinalReview = isFinalReview;

    if (isFinalReview) {
        // Modo Revis√£o Final (40 quest√µes)
        const totalFinalQuestions = 40;
        const questionsPerSubject = Math.floor(totalFinalQuestions / 4);
        
        // Coleta 10 quest√µes de cada mat√©ria
        allQuestions = allQuestions.concat(selectRandomQuestions(localQuestionBanks.math, questionsPerSubject));
        allQuestions = allQuestions.concat(selectRandomQuestions(localQuestionBanks.portuguese, questionsPerSubject));
        allQuestions = allQuestions.concat(selectRandomQuestions(localQuestionBanks.science, questionsPerSubject));
        allQuestions = allQuestions.concat(selectRandomQuestions(localQuestionBanks.history, questionsPerSubject));
        
        // Embaralha o conjunto completo
        shuffle(allQuestions);
    } else {
        // Modo de revis√£o por mat√©ria (10 quest√µes)
        const bank = localQuestionBanks[subject];
        if (!bank || bank.length === 0) {
            const subjectKey = subject === 'history' ? 'Ci√™ncias Humanas (H/G)' : name;
            const bankVariable = subject === 'history' ? 'questionBank_hum' : 
                                 subject === 'math' ? 'questionBank_mat' :
                                 subject === 'portuguese' ? 'questionBank_lin' :
                                 subject === 'science' ? 'questionBank_cie' : '??';

            alert(`Banco de quest√µes para ${subjectKey} insuficiente. Necess√°rio 5, encontrado ${bank ? bank.length : 0}. Verifique o arquivo questions_${subject.substring(0, 3)}.js. A vari√°vel esperada √©: ${bankVariable}.`);
            return; // Permanece na tela de sele√ß√£o
        }
        allQuestions = selectRandomQuestions(bank, 10);
    }

    // Reinicializa o estado para o novo quiz
    state.totalQuestions = allQuestions.length;
    state.questions = allQuestions.map(q => ({
        ...q,
        options: shuffle(q.options), // Embaralha as op√ß√µes
        answered: false,
        userAnswer: null,
        isCorrect: null,
    }));
    state.currentQuestionIndex = 0;
    state.correctAnswers = 0;
    state.incorrectAnswers = 0;
    state.report = {
        totalQuestions: state.totalQuestions,
        correct: 0,
        incorrect: 0,
        details: {},
    };
    state.skillFeedback = null;

    // Transiciona para a pr√≥xima fase
    state.currentStage = 3; 
    renderApp();
}

/**
 * Processa a resposta do usu√°rio e avan√ßa para o feedback.
 * @param {string} selectedAnswer - A op√ß√£o selecionada pelo usu√°rio.
 */
function submitAnswer(selectedAnswer) {
    if (state.currentStage !== 3 || state.questions[state.currentQuestionIndex].answered) return;

    const currentQuestion = state.questions[state.currentQuestionIndex];
    const isCorrect = selectedAnswer === currentQuestion.answer;
    
    // Atualiza o estado da quest√£o
    currentQuestion.answered = true;
    currentQuestion.userAnswer = selectedAnswer;
    currentQuestion.isCorrect = isCorrect;

    // Atualiza o estado geral
    if (isCorrect) {
        state.correctAnswers++;
        state.report.correct++;
    } else {
        state.incorrectAnswers++;
        state.report.incorrect++;
    }

    // Atualiza o relat√≥rio de habilidades
    const skill = currentQuestion.skill.split(' - ')[0]; // Usa apenas o c√≥digo da BNCC
    if (!state.report.details[skill]) {
        state.report.details[skill] = { correct: 0, incorrect: 0, rationale: currentQuestion.rationale, subject: state.subjectName };
    }
    isCorrect ? state.report.details[skill].correct++ : state.report.details[skill].incorrect++;
    
    // Armazena o feedback imediato da habilidade
    state.skillFeedback = {
        isCorrect: isCorrect,
        rationale: currentQuestion.rationale,
        userAnswer: selectedAnswer,
        correctAnswer: currentQuestion.answer,
    };

    state.currentStage = 4; // Vai para a tela de Feedback
    renderApp();
}

/**
 * Avan√ßa para a pr√≥xima quest√£o ou para o relat√≥rio final.
 */
function nextQuestion() {
    state.currentQuestionIndex++;

    if (state.currentQuestionIndex < state.totalQuestions) {
        state.currentStage = 3; // Volta para Atividade
    } else {
        state.currentStage = 5; // Vai para Relat√≥rio Final
    }
    state.skillFeedback = null;
    renderApp();
}

// --- FUN√á√ïES DE RENDERIZA√á√ÉO ---

/**
 * Renderiza a tela de sele√ß√£o de mat√©ria.
 */
function renderSelection() {
    const totalLoaded = Object.values(localQuestionBanks).reduce((sum, bank) => sum + bank.length, 0);

    const isAllReady = totalLoaded >= 20; // Pelo menos 5 quest√µes por mat√©ria

    const html = `
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-6">
            Revis√£o Din√¢mica - 2¬∫ Ano EF
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Selecione uma mat√©ria ou fa√ßa a Revis√£o Final (40 Quest√µes).
        </p>
        
        ${isAllReady ? '' : `
            <div class="text-center p-4 mb-6 bg-yellow-100 border border-yellow-500 rounded-lg">
                <p class="font-bold text-yellow-700">Aten√ß√£o: Banco de Quest√µes Insuficiente!</p>
                <p class="text-sm text-yellow-600">Total de quest√µes carregadas: ${totalLoaded}. √â recomendado pelo menos 5 por mat√©ria.</p>
            </div>
        `}

        <div class="grid grid-cols-2 gap-4">
            <button onclick="startQuiz('math', 'Matem√°tica')" 
                class="p-4 rounded-xl text-center font-bold text-lg border-b-4 border-l-2 hover:shadow-lg transition duration-150 color-math ${localQuestionBanks.math.length < 5 ? 'disabled-option opacity-50' : ''}">
                Matem√°tica 
                <span class="text-sm block">(${localQuestionBanks.math.length} Q)</span>
            </button>

            <button onclick="startQuiz('portuguese', 'L√≠ngua Portuguesa')" 
                class="p-4 rounded-xl text-center font-bold text-lg border-b-4 border-l-2 hover:shadow-lg transition duration-150 color-portuguese ${localQuestionBanks.portuguese.length < 5 ? 'disabled-option opacity-50' : ''}">
                Portugu√™s
                <span class="text-sm block">(${localQuestionBanks.portuguese.length} Q)</span>
            </button>

            <button onclick="startQuiz('science', 'Ci√™ncias')" 
                class="p-4 rounded-xl text-center font-bold text-lg border-b-4 border-l-2 hover:shadow-lg transition duration-150 color-science ${localQuestionBanks.science.length < 5 ? 'disabled-option opacity-50' : ''}">
                Ci√™ncias
                <span class="text-sm block">(${localQuestionBanks.science.length} Q)</span>
            </button>

            <button onclick="startQuiz('history', 'Ci√™ncias Humanas (H/G)')" 
                class="p-4 rounded-xl text-center font-bold text-lg border-b-4 border-l-2 hover:shadow-lg transition duration-150 color-history ${localQuestionBanks.history.length < 5 ? 'disabled-option opacity-50' : ''}">
                C. Humanas
                <span class="text-sm block">(${localQuestionBanks.history.length} Q)</span>
            </button>
        </div>

        <div class="mt-8 text-center">
             <button onclick="startQuiz('final', 'Revis√£o Final', true)" 
                class="px-6 py-3 bg-purple-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-purple-600 transition duration-150 color-final ${totalLoaded < 20 ? 'disabled-option opacity-50' : ''}">
                Revis√£o Final (40 Quest√µes)
            </button>
            <p class="text-sm text-gray-500 mt-2">Requer pelo menos 5 quest√µes de cada mat√©ria.</p>
        </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela da atividade (quest√£o).
 */
function renderActivity() {
    const current = state.questions[state.currentQuestionIndex];
    const progress = state.currentQuestionIndex + 1;
    const total = state.totalQuestions;
    const percent = Math.round((progress / total) * 100);

    const getSubjectColor = (subject) => {
        if (state.isFinalReview) {
            // No modo final, determina a cor pela 'skill' da quest√£o (c√≥digo da BNCC)
            if (subject.startsWith('EF02MA')) return 'color-math';
            if (subject.startsWith('EF02LP')) return 'color-portuguese';
            if (subject.startsWith('EF02CI')) return 'color-science';
            if (subject.startsWith('EF02HI') || subject.startsWith('EF02GE')) return 'color-history';
            return 'color-final'; // Cor padr√£o
        }
        return `color-${state.currentSubject}`;
    };

    const colorClass = getSubjectColor(current.skill);

    const html = `
        <div class="mb-6 text-center">
            <h2 class="text-2xl font-bold text-gray-700">${state.subjectName}</h2>
            <p class="text-sm text-gray-500">Quest√£o ${progress} de ${total}</p>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                <div class="h-2.5 rounded-full ${colorClass.replace('color-', 'bg-')}-500" style="width: ${percent}%"></div>
            </div>
        </div>
        
        <div class="p-6 rounded-xl border-2 border-dashed ${colorClass}">
            <p class="text-xl font-semibold text-gray-800 mb-4 animate-fade-in">${current.question}</p>
            <p class="text-xs text-gray-500 mb-4">Habilidade BNCC: ${current.skill}</p>
            <div class="space-y-3">
                ${current.options.map((option, index) => `
                    <button onclick="submitAnswer('${option.replace(/'/g, "\\'")}')" 
                        class="w-full text-left p-3 rounded-lg border-2 border-gray-300 bg-gray-50 hover:bg-gray-200 transition duration-150 font-medium text-gray-700">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </button>
                `).join('')}
            </div>
        </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de feedback ap√≥s a resposta.
 */
function renderFeedback() {
    const current = state.questions[state.currentQuestionIndex];
    const feedback = state.skillFeedback;
    const isCorrect = feedback.isCorrect;
    const subjectColor = isCorrect ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
    const progress = state.currentQuestionIndex + 1;
    const total = state.totalQuestions;

    const html = `
        <div class="text-center mb-6">
            <h2 class="text-3xl font-extrabold ${isCorrect ? 'text-green-600' : 'text-red-600'} animate-fade-in">
                ${isCorrect ? 'üéâ Parab√©ns! Resposta Certa' : 'üòî Ops! Resposta Errada'}
            </h2>
            <p class="text-sm text-gray-500 mt-1">Quest√£o ${progress} de ${total}</p>
        </div>

        <div class="p-6 rounded-xl border-2 ${subjectColor} mb-6 animate-fade-in">
            <p class="text-lg font-semibold mb-3">${current.question}</p>
            
            <p class="mt-4 text-left">
                <span class="font-bold">Sua Resposta:</span> 
                <span class="${isCorrect ? 'text-green-700 font-bold' : 'text-red-700 line-through'}">
                    ${feedback.userAnswer}
                </span>
            </p>
            
            ${!isCorrect ? `
                <p class="mt-2 text-left">
                    <span class="font-bold">Resposta Correta:</span> 
                    <span class="text-green-700 font-bold">${feedback.correctAnswer}</span>
                </p>
            ` : ''}

            <div class="mt-4 pt-3 border-t border-gray-300">
                <p class="font-bold text-md mb-2">Por Qu√™? (Racional)</p>
                <p class="text-sm text-gray-800">${feedback.rationale}</p>
                <p class="text-xs text-gray-500 mt-2">Habilidade: ${current.skill}</p>
            </div>
        </div>

        <div class="text-center">
            <button onclick="nextQuestion()" 
                class="px-8 py-3 bg-blue-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-blue-600 transition duration-150">
                ${progress < total ? 'Pr√≥xima Quest√£o' : 'Ver Relat√≥rio Final'}
            </button>
        </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de relat√≥rio final.
 */
function renderReport() {
    const total = state.report.totalQuestions;
    const correct = state.report.correct;
    const incorrect = state.report.incorrect;
    const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
    const isPassing = percentage >= 70; // Crit√©rio de aprova√ß√£o (70%)

    // Agrupa o relat√≥rio por assunto no modo final
    const finalReport = {};
    if (state.isFinalReview) {
        for (const skill in state.report.details) {
            const detail = state.report.details[skill];
            const subject = detail.subject;
            if (!finalReport[subject]) {
                finalReport[subject] = { correct: 0, incorrect: 0, total: 0, details: {} };
            }
            finalReport[subject].correct += detail.correct;
            finalReport[subject].incorrect += detail.incorrect;
            finalReport[subject].total += (detail.correct + detail.incorrect);
            finalReport[subject].details[skill] = detail;
        }
    } else {
        // Se for por mat√©ria, usa o nome da mat√©ria como chave √∫nica
        finalReport[state.subjectName] = { 
            correct: correct, 
            incorrect: incorrect, 
            total: total, 
            details: state.report.details 
        };
    }

    const getSubjectColor = (subjectName) => {
        if (subjectName.includes('Matem√°tica')) return 'color-math';
        if (subjectName.includes('Portugu√™s')) return 'color-portuguese';
        if (subjectName.includes('Ci√™ncias Humanas')) return 'color-history';
        if (subjectName.includes('Ci√™ncias')) return 'color-science';
        return 'color-final';
    };

    const html = `
        <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-6">
            Relat√≥rio de Desempenho
        </h2>

        <div class="p-6 rounded-xl border-4 ${isPassing ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} text-center mb-6 animate-fade-in">
            <p class="text-lg font-bold ${isPassing ? 'text-green-700' : 'text-red-700'}">${state.subjectName}</p>
            <p class="text-4xl font-extrabold mt-1 mb-2">${percentage}% de Acerto</p>
            <p class="text-md text-gray-700">${correct} Acertos / ${incorrect} Erros (Total: ${total})</p>
        </div>

        ${Object.keys(finalReport).map(subjectName => {
            const sub = finalReport[subjectName];
            const subPercentage = sub.total > 0 ? Math.round((sub.correct / sub.total) * 100) : 0;
            const subColor = getSubjectColor(subjectName);
            const subBgClass = subColor.replace('color-', 'bg-');
            
            return `
                <div class="mb-6 p-4 rounded-xl border-2 ${subColor} ${subBgClass}-50 animate-fade-in">
                    <h3 class="text-xl font-bold text-gray-700 mb-3">${subjectName} (${subPercentage}% de Acerto)</h3>
                    <p class="text-sm text-gray-600 mb-4">${sub.correct} Acertos / ${sub.incorrect} Erros</p>

                    <h4 class="font-bold text-gray-600 mb-2 border-t pt-2">An√°lise por Habilidade (BNCC):</h4>
                    <ul class="space-y-2 text-sm">
                        ${Object.keys(sub.details).map(skill => {
                            const detail = sub.details[skill];
                            const skillAccuracy = detail.correct + detail.incorrect > 0 ? Math.round((detail.correct / (detail.correct + detail.incorrect)) * 100) : 0;
                            const skillBg = skillAccuracy >= 70 ? 'bg-green-200' : skillAccuracy >= 50 ? 'bg-yellow-200' : 'bg-red-200';
                            
                            return `
                                <li class="p-2 rounded-lg ${skillBg} flex justify-between items-center">
                                    <span class="font-semibold">${skill}</span>
                                    <span class="font-bold">${skillAccuracy}% (${detail.correct}/${detail.correct + detail.incorrect})</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
            `;
        }).join('')}

        <div class="mt-8 text-center">
            <button onclick="state.currentStage = 1; renderApp();" 
                class="px-6 py-3 bg-blue-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-blue-600 transition duration-150">
                Come√ßar Nova Revis√£o (Voltar ao In√≠cio)
            </button>
        </div>
    `;
    document.getElementById('app').innerHTML = html;
}

// --- Controlador Principal (StateMachine) ---
function renderApp() {
    try {
        switch (state.currentStage) {
            case 1:
            renderSelection();
            break;
            // case 2 (renderTransition) foi removido
            case 3:
            renderActivity();
            break;
            case 4: 
            renderFeedback();
            break;
            case 5:
            renderReport(); 
            break;
            case 6:
            renderEnd(); 
            break;
            default:
            renderSelection();
            break;
        }
    } catch (error) {
        // Tratamento de erro robusto
        console.error("Erro fatal na aplica√ß√£o:", error);
        document.getElementById('app').innerHTML = `
            <div class="text-center p-8 bg-red-100 border-2 border-red-500 rounded-xl">
                <h2 class="text-2xl text-red-700">Ocorreu um Erro!</h2>
                <p class="text-gray-600">Por favor, reinicie a p√°gina.
                Detalhes: ${error.message}. Certifique-se de que os arquivos questions_*.js existem e n√£o est√£o vazios. **Verifique o console (F12) para detalhes.**</p>

                <button onclick="window.location.reload();" 
                    class="mt-4 px-6 py-3 bg-red-500 text-white font-bold text-xl rounded-xl shadow-lg hover:bg-red-600 transition duration-150">
                    Recarregar P√°gina
                </button>
            </div>
        `;
    }
}

// Inicia a aplica√ß√£o
document.addEventListener('DOMContentLoaded', renderApp);
</script>

</body>
</html>
