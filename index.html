<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Revis√£o Din√¢mica do 2¬∫ Ano EF - Qualidade e BNCC</title>
<script src="https://cdn.tailwindcss.com"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JT5Q6BV0XL"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-JT5Q6BV0XL');
</script>
<style>
/* Estilo base com fonte Inter (Para apar√™ncia infantil e moderna) */
 @import url('https://fonts.googleapis.com/css2?
family=Inter:wght400;600;700;800&display=swap');
body {
font-family: 'Inter', sans-serif;
background-color: #fce4ec; /* Rosa claro base */
transition: background-color 0.5s ease-in-out;
min-height: 100vh;
display: flex;
justify-content: center;
align-items: center;
}
.container-box {
max-width: 650px;
min-height: 400px;
}
.theme-button {
transition: all 0.2s;
box-shadow: 0 4px 0 0 #d81b60; /* Sombra 3D Rosa */
border-radius: 1rem;
}
.theme-button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 0 0 #c2185b;
}
.theme-button:active {
transform: translateY(2px);
box-shadow: 0 2px 0 0 #d81b60;
}
.subject-card {
background-color: #ffffff;
border: 2px solid #ff4081;
padding: 1.5rem;
border-radius: 1rem;
box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
transition: transform 0.3s ease;
}
.subject-card:hover {
transform: translateY(-5px);
}
.report-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 1rem;
}
</style>
</head>
<body>
<div id="app" class="w-full p-4 md:p-8">
</div>

<script src="questions_mat.js"></script>
<script src="questions_lin.js"></script>
<script src="questions_cie.js"></script>
<script src="questions_his.js"></script>
<script type="text/javascript">
// ATEN√á√ÉO: A Chave de API do Gemini √© mantida apenas para a AN√ÅLISE DE HABILIDADES (Relat√≥rio Final)
const GEMINI_API_KEY = typeof _api_key !== 'undefined' ? _api_key :
"AIzaSyCTrba7udUnc_rm7ejgfUcfQqTbaNXGnuw";
// Define o tamanho fixo da sess√£o
const SESSION_SIZE = 5;

// --- Bancos de Quest√µes Locais (questions_sub.js) ---
// Estes arrays ser√£o preenchidos pelos scripts externos (questions_*.js)
const localQuestionBanks = {
    math: typeof mathQuestions !== 'undefined' ? mathQuestions : [],
    portuguese: typeof portugueseQuestions !== 'undefined' ? portugueseQuestions : [],
    science: typeof scienceQuestions !== 'undefined' ? scienceQuestions : [],
    history: typeof historyQuestions !== 'undefined' ? historyQuestions : [],
};


// Vari√°vel de estado global
let state = {};
// Vari√°vel para armazenar as estat√≠sticas consolidadas
let allTimeStats = {
    math: { name: "Matem√°tica", correct: 0, wrong: 0, total: 0, color: "blue" },
    portuguese: { name: "Portugu√™s", correct: 0, wrong: 0, total: 0, color: "green" },
    science: { name: "Ci√™ncias", correct: 0, wrong: 0, total: 0, color: "yellow" },
    history: { name: "Hist√≥ria", correct: 0, wrong: 0, total: 0, color: "red" },
};
// Hist√≥rico de √≠ndices de quest√µes j√° usadas (para evitar repeti√ß√£o)
let questionsHistory = {
    math: [],
    portuguese: [],
    science: [],
    history: [],
};

// Fun√ß√£o de utilidade para o API Call (Exponential Backoff) - Mantida para o Relat√≥rio de Habilidades
async function fetchWithRetry(url, options, maxRetries = 5) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(url, options);
            if (response.ok) return response;
            if (response.status === 401) throw new Error("Chave de API inv√°lida.");
            if (response.status === 429) {
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                continue;
            }
            throw new Error(`Erro HTTP: ${response.status}`);
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}


// --- Estrutura das Mat√©rias ALINHADA √Ä BNCC (2¬∞ ANO EF)
const subjects = {
    math: {
        name: "Matem√°tica",
        icon: "‚ûï",
        color: "bg-blue-500",
        // Habilidades BNCC (Exemplos): EF02MA01, EF02MA05, EF02MA12
        bncc_focus: "EF02MA01 (ler, escrever e comparar n√∫meros naturais at√© 1000), EF02MA05 (construir fatos b√°sicos da adi√ß√£o e subtra√ß√£o), EF02MA06 (resolver problemas de adi√ß√£o e subtra√ß√£o), EF02MA12 (identificar e planificar figuras planas e espaciais), EF02MA15 (comparar capacidade e massa)."
    },
    portuguese: {
        name: "Portugu√™s",
        icon: "üìñ",
        color: "bg-green-500",
        // Habilidades BNCC (Exemplos): EF02LP01, EF02LP07, EF02LP15
        bncc_focus: "EF02LP01 (ler e escrever palavras com correspond√™ncias regulares e irregulares), EF02LP07 (segmentar palavras em s√≠labas), EF02LP10 (identificar sin√¥nimos e ant√¥nimos), EF02LP15 (ler e compreender textos curtos, com autonomia), EF02LP18 (planejar e produzir frases e pequenos textos)."
    },
    science: {
        name: "Ci√™ncias",
        icon: "üî¨",
        color: "bg-yellow-500",
        // Habilidades BNCC (Exemplos): EF02CI04, EF02CI05, EF02CI06
        bncc_focus: "EF02CI04 (descrever caracter√≠sticas de plantas e animais), EF02CI05 (identificar materiais utilizados em objetos e suas fontes), EF02CI06 (identificar e classificar os cinco sentidos), EF02CI07 (descrever o ciclo da √°gua e a import√¢ncia para a vida)."
    },
    history: {
        name: "Hist√≥ria",
        icon: "üï∞Ô∏è",
        color: "bg-red-500",
        // Habilidades BNCC (Exemplos): EF02HI01, EF02HI02, EF02HI07
        bncc_focus: "EF02HI01 (reconhecer o papel da fam√≠lia e da escola), EF02HI02 (identificar e descrever pr√°ticas e ritmos de vida no presente e passado), EF02HI07 (identificar e utilizar diferentes marcadores do tempo - dia/noite, semana, m√™s), EF02HI10 (selecionar objetos e documentos pessoais para an√°lise)."
    }
};

function generateSessionId() {
    return 'sess-' + Date.now() + Math.random().toString(16).slice(2);
}


// --- Gera√ß√£o de Quest√µes do Banco Local ---
/**
 * Seleciona 5 quest√µes √∫nicas e aleat√≥rias do banco local, evitando repeti√ß√£o.
 * As quest√µes devem ter o formato { question, answer, options, skill, rationale, isCorrect }
 * @param {string} subjectKey - Chave da mat√©ria (ex: 'math').
 * @returns {Array} - Array de 5 objetos de atividade formatados.
 * @throws {Error} - Se o banco de quest√µes estiver vazio ou insuficientemente preenchido.
 */
function getQuestionsFromLocalBank(subjectKey) {
    const fullBank = localQuestionBanks[subjectKey];
    const usedIndices = questionsHistory[subjectKey];
    const totalQuestions = fullBank.length;

    if (totalQuestions < SESSION_SIZE) {
        throw new Error(`Banco de quest√µes para ${subjects[subjectKey].name} insuficiente. Necess√°rio ${SESSION_SIZE}, encontrado ${totalQuestions}. Verifique o arquivo questions_${subjectKey}.js.`);
    }

    let availableIndices = [];
    for (let i = 0; i < totalQuestions; i++) {
        if (!usedIndices.includes(i)) {
            availableIndices.push(i);
        }
    }

    // Se as quest√µes esgotaram, reinicia o ciclo
    if (availableIndices.length < SESSION_SIZE) {
        console.warn(`Banco de quest√µes esgotado para ${subjectKey}. Reiniciando o ciclo de ${totalQuestions} quest√µes.`);
        questionsHistory[subjectKey] = [];
        availableIndices = [];
        for (let i = 0; i < totalQuestions; i++) {
            availableIndices.push(i);
        }
    }

    const selectedQuestions = [];
    const selectedIndicesForThisSession = [];
    let count = 0;

    while (count < SESSION_SIZE) {
        // Sele√ß√£o aleat√≥ria
        const randomIndexInAvailable = Math.floor(Math.random() * availableIndices.length);
        const questionIndex = availableIndices[randomIndexInAvailable];

        // 3. Pega a quest√£o, armazena o √≠ndice e remove o √≠ndice da lista de dispon√≠veis para evitar repeti√ß√£o NA SESS√ÉO ATUAL.
        selectedQuestions.push(JSON.parse(JSON.stringify(fullBank[questionIndex]))); // Clone para n√£o afetar o banco original

        selectedIndicesForThisSession.push(questionIndex);
        availableIndices.splice(randomIndexInAvailable, 1);
        count++;
    }

    // 4. Adiciona os √≠ndices usados ao hist√≥rico global (para evitar repeti√ß√£o em sess√µes futuras)
    questionsHistory[subjectKey].push(...selectedIndicesForThisSession);

    return selectedQuestions;
}


// --- Fun√ß√µes de Estado e Controle
/**
 * Inicializa o estado da sess√£o.
 */
function resetApp() {
    state = {
        currentStage: 1, // 1: Sele√ß√£o de Tema, 2: Removido/Carregamento, 3: Atividade, 4: Feedback, 5: Relat√≥rio, 6: Fim de Sess√£o
        currentSubject: null,
        sessionActivities: [],
        activityIndex: 0,
        maxScore: SESSION_SIZE,
        score: 0,
        sessionId: generateSessionId(),
        isLastAnswerCorrect: null
    };
    renderApp();
}

/**
 * Adiciona os resultados da sess√£o atual √†s estat√≠sticas consolidadas.
 */
function aggregateSessionResults() {
    const subjectKey = state.currentSubject;
    const correct = state.score;
    const total = state.maxScore;
    const wrong = total - correct;
    
    // 1. Agrega Estat√≠sticas
    if (allTimeStats[subjectKey]) {
        allTimeStats[subjectKey].correct += correct;
        allTimeStats[subjectKey].wrong += wrong;
        allTimeStats[subjectKey].total += total;
    } else {
        allTimeStats[subjectKey] = {
            name: subjects[subjectKey] ? subjects[subjectKey].name : subjectKey,
            correct: correct,
            wrong: wrong,
            total: total,
            color: "gray"
        };
    }
    console.log("Estat√≠sticas consolidadas atualizadas.");
}

/**
 * Prepara e inicia uma nova sess√£o de revis√£o.
 * @param {string} subjectKey - Chave da mat√©ria (ex: 'math').
 */
async function startSession(subjectKey) {
    state.currentSubject = subjectKey;

    try {
        const generatedActivities = getQuestionsFromLocalBank(subjectKey);
        
        // 4. Configura o estado da sess√£o
        state.sessionActivities = generatedActivities;
        state.activityIndex = 0;
        state.score = 0;
        state.currentStage = 3; // Inicia a atividade (Stage 3)
        renderApp();
    } catch (error) {
        // Em caso de falha (banco vazio), volta para a sele√ß√£o e mostra o erro
        state.currentStage = 1;
        renderApp();
        document.getElementById('app').querySelector('.container-box').innerHTML += `
        <div class="mt-6 p-4 bg-red-100 text-red-800 rounded-lg">
        <p class="font-bold"> ‚ùå Erro ao Iniciar Sess√£o!</p>
        <p class="text-sm">Detalhes: ${error.message}. Por favor, verifique se o banco de quest√µes est√° preenchido corretamente.</p>
        </div>
        `;
    }
}

/**
 * Processa a resposta do usu√°rio e avan√ßa para a tela de feedback.
 * @param {string} selectedOption - A op√ß√£o escolhida pelo usu√°rio.
 */
function submitAnswer(selectedOption) {
    const currentActivity = state.sessionActivities[state.activityIndex];
    // Verifica a resposta
    const isCorrect = selectedOption === currentActivity.answer;
    state.isLastAnswerCorrect = isCorrect;
    if (isCorrect) {
        state.score++;
        currentActivity.isCorrect = true;
    } else {
        currentActivity.isCorrect = false;
    }
    // Vai para o est√°gio de feedback (Stage 4)
    state.currentStage = 4;
    renderApp();
}

/**
 * Avan√ßa para a pr√≥xima quest√£o ou para o fim da sess√£o. Chamado pelo bot√£o de feedback.
 */
function nextQuestion() {
    state.activityIndex++;
    if (state.activityIndex < state.maxScore) {
        // Se ainda houver atividades, vai para a pr√≥xima (Stage 3)
        state.currentStage = 3;
    } else {
        // Se a sess√£o terminou, vai para o fim (Stage 6)
        state.currentStage = 6;
    }
    renderApp();
}

/**
 * Fun√ß√£o principal que chama a API do Gemini para an√°lise de habilidades e dicas. (MANTIDA)
 */
async function generateSkillReportAndTips() {
    const reportContainer = document.getElementById('skill-report-container');
    const subjectName = subjects[state.currentSubject].name;
    
    if (!GEMINI_API_KEY) {
        reportContainer.innerHTML = `
        <div class="mt-6 p-4 bg-yellow-100 text-yellow-800 rounded-lg">
        <p class="font-bold"> Chave de API Ausente ou Inv√°lida!</p>
        <p class="text-sm">Insira a chave Gemini API no c√≥digo para gerar a an√°lise de
        habilidades e as dicas personalizadas. Sem chave, a an√°lise n√£o √© poss√≠vel.</p>
        </div>
        `;
        return;
    }

    const sessionResults = state.sessionActivities.map((activity, index) => {
        const result = activity.isCorrect ? 'ACERTO' : 'ERRO';
        // Usa a quest√£o e a habilidade (c√≥digo BNCC) para a an√°lise
        return `Quest√£o ${index + 1}: Pergunta: "${activity.question}", Habilidade (BNCC): "${activity.skill}", Resultado: ${result}`;
    }).join('; ');

    // Prompt ajustado para tratar a habilidade como c√≥digo BNCC
    const systemPrompt = "Voc√™ √© um professor/tutor de 2¬∫ ano do Ensino Fundamental, amig√°vel e encorajador. Sua tarefa √© analisar os resultados da sess√£o de revis√£o e fornecer feedback construtivo. O feedback deve ser estritamente em Portugu√™s do Brasil. O campo 'skill_analysis' deve ser um relat√≥rio formatado com quebras de linha (usando '\\n' ou quebras de par√°grafo) listando cada habilidade testada (incluindo o c√≥digo BNCC) com o n√∫mero da quest√£o e o resultado (ACERTO/ERRO), de forma que cada item fique em sua pr√≥pria linha para melhor leitura. O campo 'improvement_tips' deve ser um pequeno texto (m√°ximo 3 frases) com dicas espec√≠ficas para a crian√ßa melhorar nas habilidades que ela errou, mantendo um tom positivo e simples.";
    const userQuery = `Analise a seguinte sess√£o de revis√£o na mat√©ria de ${subjectName}. A crian√ßa tentou ${state.maxScore} quest√µes. Aqui est√£o os resultados (Quest√£o, Habilidade BNCC, Resultado): ${sessionResults}. Gere o relat√≥rio e as dicas.`;

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
                type: "OBJECT",
                properties: {
                    "skill_analysis": { "type": "STRING" },
                    "improvement_tips": { "type": "STRING" }
                },
                propertyOrdering: ["skill_analysis", "improvement_tips"]
            }
        }
    };

    reportContainer.innerHTML =`
    <div class="mt-6 flex items-center justify-center p-4 bg-gray-50 rounded-lg shadow-inner">
    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-pink-600"
    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-
    width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0
    5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="text-gray-700 font-semibold">Analisando habilidades (BNCC)
    dinamicamente...</span>
    </div>
    `;

    try {
        const response = await fetchWithRetry(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (jsonText) {
            const parsedJson = JSON.parse(jsonText);
            const analysis = parsedJson.skill_analysis;
            const tips = parsedJson.improvement_tips;

            reportContainer.innerHTML = `
            <div class="mt-6 p-5 bg-gray-50 rounded-lg shadow-inner text-left">
            <h3 class="text-2xl font-extrabold mb-3 text-pink-600"> Amostragem de üéØ
            Habilidades (An√°lise BNCC)</h3>
            
            <pre class="mb-4 text-md text-gray-700 whitespace-pre-wrap">${analysis}</pre>
            
            <h3 class="text-xl font-bold mt-5 mb-2 text-indigo-600">Dicas para 
            Melhoria:</h3>
            <p class="text-lg text-gray-800 italic">${tips}</p>
            </div>
            `;
        } else {
            reportContainer.innerHTML = `
            <div class="mt-6 p-4 bg-red-100 text-red-800 rounded-lg">
            <p class="font-bold"> ‚ùå Erro na Gera√ß√£o do Relat√≥rio:</p> 
            <p class="text-sm">A API n√£o retornou o conte√∫do esperado.
            Verifique a chave 
            ou o limite de uso.</p>
            </div>
            `;
        }
    } catch (error) {
        console.error("Erro ao chamar a API Gemini para an√°lise:", error);
        reportContainer.innerHTML = `
        <div class="mt-6 p-4 bg-red-100 text-red-800 rounded-lg">
        <p class="font-bold"> ‚ùå Erro de Conex√£o ou API:</p>
        <p class="text-sm">N√£o foi poss√≠vel gerar a an√°lise.
        Detalhes: 
        ${error.message}.</p>
        </div>
        `;
    }
}


// --- Renderiza√ß√£o de Telas (Stages) ---
/**
 * Renderiza a tela de Sele√ß√£o de Tema (Stage 1).
 */
function renderSelection() {
    
    const subjectCards = Object.keys(subjects).map(key => {
        const subj = subjects[key];
        const questionCount = localQuestionBanks[key].length;

        return `
        <div class="subject-card cursor-pointer hover:shadow-xl" onclick="startSession('${key}')">
        <div class="text-4xl mb-2">${subj.icon}</div>
        <h3 class="text-xl font-bold text-gray-800">${subj.name}</h3>
        <p class="text-sm text-gray-500">Total de Quest√µes: ${questionCount}. Sess√£o: ${SESSION_SIZE} Quest√µes.</p>
        </div>
        `;
    }).join('');

    const html = `
    <div class="container-box mx-auto bg-white p-8 rounded-2xl shadow-2xl text-center">
    <h1 class="text-3xl font-extrabold mb-4 text-pink-600">Revis√£o Din√¢mica do 2¬∫ Ano 
    EF</h1>
    <p class="text-gray-600 mb-6">Escolha o tema. As quest√µes s√£o carregadas do banco local, garantindo ineditismo por at√© 20 sess√µes!</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
    ${subjectCards}
    </div>
    ${Object.values(allTimeStats).some(stat => stat.total > 0) ?
    `
    <button onclick="state.currentStage = 5; renderApp();" 
    class="w-full md:w-auto px-6 py-3 bg-indigo-500 text-white font-bold text-lg 
    rounded-xl shadow-lg theme-button hover:bg-indigo-600 transition duration-150">
    Ver Relat√≥rio de Sess√µes Anteriores üìä
    </button>
    ` : `
    <button class="w-full md:w-auto px-6 py-3 bg-gray-400 text-white font-bold text-lg 
    rounded-xl shadow-lg cursor-not-allowed">
    Relat√≥rio dispon√≠vel ap√≥s a 1¬™ revis√£o üìä
    </button>
    `}
    </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de Atividade (Quest√£o) (Stage 3).
 */
function renderActivity() {
    const currentActivity = state.sessionActivities[state.activityIndex];
    const subj = subjects[state.currentSubject];
    // Embaralha as op√ß√µes para que a resposta correta n√£o seja sempre a primeira
    const shuffledOptions = [...currentActivity.options].sort(() => 0.5 - Math.random());
    const optionsHtml = shuffledOptions.map(option => `
    <button onclick="submitAnswer('${option.replace(/'/g, "\\'")}')"
    class="w-full py-3 px-4 mb-3 bg-gray-100 text-gray-800 font-semibold rounded-lg 
    border-2 border-gray-300 hover:bg-pink-100 hover:border-pink-500 transition duration-100 text-lg 
    text-left shadow-md">
    ${option}
    </button>
    `).join('');
    // Certifique-se de que a quest√£o tamb√©m √© exibida
    const questionText = currentActivity.question || "Carregando pergunta...";
    const html = `
    <div class="container-box mx-auto bg-white p-8 rounded-2xl shadow-2xl text-left border 
    t-8 border-${subj.color.split('-')[1]}-500">
    <div class="mb-4 flex justify-between items-center">
    <span class="text-lg font-bold text-gray-600">${subj.icon} ${subj.name}</span>
    <span class="text-2xl font-extrabold text-pink-600">Quest√£o ${state.activityIndex +
    1} / ${state.maxScore}</span>
    </div>
    <p class="text-2xl font-bold mb-6 text-gray-900">${questionText}</p>
    <p class="text-xs text-gray-400 mb-4">Habilidade BNCC: 
    ${currentActivity.skill}</p>
    <div class="options-container">
    ${optionsHtml}
    </div>
    </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de Feedback Imediato (Stage 4).
 */
function renderFeedback() {
    const isCorrect = state.isLastAnswerCorrect;
    const message = isCorrect ?
    "Parab√©ns! Voc√™ acertou! üéâ" : "Ops! Voc√™ errou. Vamos tentar a pr√≥xima! ü§î";
    const bgColor = isCorrect ? "bg-blue-100 border-blue-500" : "bg-red-100 border-red-500";
    const textColor = isCorrect ? "text-blue-800" : "text-red-800";
    const buttonColor = isCorrect ? "bg-blue-500 hover:bg-blue-600" : "bg-red-500 hover:bg-red-600";
    
    const currentActivity = state.sessionActivities[state.activityIndex];
    const buttonText = state.activityIndex < state.maxScore - 1 ? "Pr√≥xima Quest√£o" : "Ver Relat√≥rio Final";
    const html = `
    <div class="container-box mx-auto bg-white p-8 rounded-2xl shadow-2xl text-center">
    <div class="p-8 rounded-2xl border-4 ${bgColor} ${textColor} animate-bounce" 
    style="animation-duration: 0.5s;">
    <p class="text-4xl font-extrabold mb-4">${isCorrect ?
    "‚úÖ" : "‚ùå"}</p>
    <h2 class="text-3xl font-bold">${message}</h2>
    </div>
    
    <div class="mt-6 p-4 bg-gray-50 rounded-lg text-left">
    <p class="font-bold text-lg text-pink-600">Resposta Correta:</p>
    <p class="text-xl text-gray-800">${currentActivity.answer}</p>
    </div>
    <button onclick="nextQuestion()" 
    class="mt-8 px-8 py-4 ${buttonColor} text-white font-extrabold text-xl rounded 
    xl shadow-lg theme-button transition duration-150">
    ${buttonText}
    </button>
    </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de Relat√≥rio Consolidado (Stage 5).
 */
function renderReport() {

    const statsEntries = Object.values(allTimeStats).filter(stat => stat.total > 0); 
    let reportHtml = '';
    if (statsEntries.length === 0) {
        reportHtml = `
        <p class="text-xl text-gray-500">Nenhum dado de sess√£o anterior encontrado.
        Tente 
        completar uma revis√£o primeiro!</p>
        `;
    } else {
        reportHtml = statsEntries.map(stat => {
            const percentageCorrect = stat.total > 0 ? ((stat.correct / stat.total) * 100).toFixed(0) : 0;
            const barColor = percentageCorrect >= 70 ? 'bg-green-500' : percentageCorrect >= 50 ?
            'bg-yellow-500' : 'bg-red-500';
            return `
            <div class="p-5 bg-white rounded-xl shadow-lg border-l-8 border-${stat.color.split('-')[1]}-500 
            transition duration-300 hover:shadow-xl">
            <h3 class="text-2xl font-bold mb-2 text-gray-800">${stat.name}</h3>
            
            <div class="mb-3 text-sm text-gray-600">
            <span>Total de Quest√µes: <span 
            class="font-bold">${stat.total}</span></span> |
            <span class="text-green-600">Acertos: <span class="font-bold">
            ${stat.correct}</span></span> |
            <span class="text-red-600">Erros: <span 
            class="font-bold">${stat.wrong}</span></span>
            </div>
        
            <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
            <div class="h-4 rounded-full ${barColor}" style="width: ${percentageCorrect}
            %; transition: width 1s ease-out;"></div>
            <span class="absolute right-0 top-0 bottom-0 flex items-center pr-3 font-bold 
            text-xs ${percentageCorrect > 50 ?
            'text-white' : 'text-gray-800'}">
            ${percentageCorrect}%
            </span>
            </div>
            <p class="mt-2 text-sm text-gray-500">Aproveitamento geral.</p>
            </div>
            `;
        }).join('');
        reportHtml = `<div class="report-grid">${reportHtml}</div>`;
    }

    const html = `
    <div class="container-box mx-auto bg-white p-8 rounded-2xl shadow-2xl text-center">
    <h2 class="text-4xl font-extrabold mb-2 text-pink-600"> Relat√≥rio üìä
    Consolidado</h2>
    <p class="text-lg text-gray-700 mb-6">Desempenho acumulado de todas as revis√µes 
    nesta sess√£o:</p>

    ${reportHtml}
    <button onclick="state.currentStage = 1; renderApp();" 
    class="mt-8 w-full md:w-auto px-6 py-3 bg-red-500 text-white font-bold text-lg 
    rounded-xl shadow-lg theme-button hover:bg-red-600 transition duration-150">
    Voltar ao Menu Principal
    </button>
    </div>
    `;
    document.getElementById('app').innerHTML = html;
}

/**
 * Renderiza a tela de Fim de Sess√£o (Stage 6).
 */
function renderEnd() {
    const subj = subjects[state.currentSubject];
    const totalQuestions = state.maxScore;
    const correctAnswers = state.score;
    const wrongAnswers = totalQuestions - correctAnswers;
    
    aggregateSessionResults(); // Agrega estat√≠sticas
    let feedbackMessage = "";
    let emoji = "";
    if (correctAnswers === totalQuestions) {
        feedbackMessage = "Incr√≠vel! Voc√™ acertou todas as quest√µes!";
        emoji = "‚≠ê"; 
    } else if (correctAnswers >= totalQuestions * 0.7) {
        feedbackMessage = "Muito bem! Excelente trabalho na revis√£o!";
        emoji = "üòä";
    } else {
        feedbackMessage = "Continue praticando! A repeti√ß√£o leva √† perfei√ß√£o.";
        emoji = "üëç";
    }

    const html = `
    <div class="container-box mx-auto bg-white p-8 rounded-2xl shadow-2xl text-center 
    border-t-8 border-${subj.color.split('-')[1]}-500">
    <h2 class="text-4xl font-extrabold mb-4 text-pink-600">Revis√£o Finalizada!
    ${emoji}</h2>
    <p class="text-2xl font-semibold mb-4 text-gray-800">${feedbackMessage}</p>
    
    <div class="my-6 p-4 bg-gray-50 rounded-lg">
    <p class="text-lg font-bold">Resumo da Sess√£o de ${subj.name}:</p>
    <p class="text-xl text-green-600 font-extrabold">Acertos: ${correctAnswers}</p>
    <p class="text-xl text-red-600 font-extrabold">Erros: ${wrongAnswers}</p>
    <p class="text-md text-gray-500">Total de Quest√µes: ${totalQuestions}</p>
    </div>
    <div id="skill-report-container" class="text-left">
    </div>
    <button onclick="state.currentStage = 1; renderApp();"
    class="mt-8 px-6 py-3 bg-blue-500 text-white font-bold text-xl rounded-xl 
    shadow-lg theme-button hover:bg-blue-600 transition duration-150">
    Come√ßar Nova Revis√£o (Voltar ao In√≠cio)
    </button>
    </div>
    `;
    document.getElementById('app').innerHTML = html;
    
    // Chama a an√°lise da Gemini imediatamente ap√≥s renderizar a tela
    generateSkillReportAndTips();
}
// --- Controlador Principal (StateMachine) ---
function renderApp() {
    try {
        switch (state.currentStage) {
            case 1:
            renderSelection();
            break;
            // case 2 (renderTransition) foi removido
            case 3:
            renderActivity();
            break;
            case 4: 
            renderFeedback();
            break;
            case 5:
            renderReport(); 
            break;
            case 6:
            renderEnd(); 
            break;
            default:
            renderSelection();
            break;
        }
    } catch (error) {
        // Tratamento de erro robusto
        console.error("Erro fatal na aplica√ß√£o:", error);
        document.getElementById('app').innerHTML = `
        <div class="text-center p-8 bg-red-100 border-2 border-red-500 rounded-xl">
        <h2 class="text-2xl text-red-700">Ocorreu um Erro!</h2>
        <p class="text-gray-600">Por favor, reinicie a p√°gina.
        Detalhes: ${error.message}. Certifique-se de que os arquivos questions_*.js existem e n√£o est√£o vazios.</p>

        <button onclick="window.location.reload();" 
        class="mt-4 px-6
        py-3 bg-red-500 text-white font-bold text-xl rounded-xl shadow-lg theme-button hover:bg-red 
        600">
        Recarregar
        </button>
        </div>
        `;
    }
}
// Inicia a aplica√ß√£o
window.onload = resetApp;
</script>
</body>
</html>
